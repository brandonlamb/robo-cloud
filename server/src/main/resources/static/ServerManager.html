<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Robot Server Management Console</title>
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"><body>
<script>
    var canvas;
    var ctx;
    var image = new Image();
    var count = 0;

    function connect() {
        console.log("Begin connect");
        socket = new WebSocket("ws://" + window.location.host + "/arenas");

        socket.onerror = function() {
            console.log("socket error");
        };

        socket.onopen = function() {
            console.log("Connected");
        };

        socket.onclose = function(evt) {
            var explanation = "";
            if (evt.reason && evt.reason.length > 0) {
                explanation = "reason: " + evt.reason;
            } else {
                explanation = "without a reason specified";
            }

            console.log("Disconnected with close code " + evt.code + " and " + explanation);

        };

        socket.onmessage = function(event) {
            var view = JSON.parse(event.data);
            count++;
            $('#counter').text(count);
            render(view);
        };
    }

    function render(arenaView) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for(i=0; i<arenaView.robots.length; i++){
            var robot = arenaView.robots[i]
            ctx.save();
            ctx.beginPath();
            ctx.translate(robot.box.coordinates.x, robot.box.coordinates.y);
            //ctx.translate(32 * i + 32, 48)
            ctx.rotate(robot.box.bearing);
            ctx.drawImage(image, -32, -32, 64, 64);
            ctx.fill();
            ctx.restore();
        }
    }

    $(document).ready(function() {
        image.src = "/static/images/ship.png"
        canvas = document.getElementById("arena");
        ctx = canvas.getContext("2d");
        $( "#connectButton" ).click(function() {
            connect();
        });
    });


</script>
<div class="container">
    <div class="row">
        <div class="col-lg-10">
            <canvas id="arena" width="1024" height="768" style="background: #1f1822"></canvas>
        </div>

    </div>
    <div class="row">
        <div class="col-lg-2">
            <button type="button" class="btn btn-primary" id="connectButton">Connect</button>
        </div>
        <div class="col-lg-2">
            Frames received: <span id="counter">0</span>
        </div>
    </div>


</div>
</body>
</html>